{% extends "base.html" %} {% block title %}Ask the Agent{% endblock %} {% block
content %}
<style>
  .chat-container {
    max-width: 900px;
    margin: auto;
  }
  .chat-box {
    height: 70vh;
    display: flex;
    flex-direction: column;
    border-radius: 0.25rem;
  }
  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
  }
  .message {
    display: flex;
    margin-bottom: 1rem;
  }
  .message.user-message {
    justify-content: flex-end;
  }
  .message-content {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    max-width: 75%;
  }
  .user-message .message-content {
    background-color: var(--bs-primary);
    color: white;
    border-top-right-radius: 0;
  }
  .agent-message .message-content {
    background-color: #e9ecef;
    color: #212529;
    border-top-left-radius: 0;
  }
  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
  }
  .user-message .message-avatar {
    margin-left: 1rem;
    margin-right: 0;
  }
</style>

<div class="chat-container">
  <div class="card">
    <div class="card-header text-center">
      <h1 class="h3">AI Financial Assistant</h1>
    </div>
    <div class="card-body chat-box">
      <div id="chat-messages" class="chat-messages">
        <div class="message agent-message">
          <div class="message-avatar">AI</div>
          <div class="message-content">
            Hello! I'm your AI budgeting assistant. Ask me anything about your
            spending, budget, or transactions. For example:
            <ul>
              <li><em>How much did I spend on groceries last month?</em></li>
              <li><em>Am I over budget on restaurants?</em></li>
              <li><em>What were my 5 largest expenses?</em></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-footer bg-white">
        <form id="chat-form" class="d-flex">
          <input
            type="text"
            id="message-input"
            class="form-control me-2"
            placeholder="Ask a question..."
            required
          />
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block body_scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const chatMessages = document.getElementById("chat-messages");

    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const userQuery = messageInput.value.trim();
      if (!userQuery) return;

      appendMessage("You", userQuery, "user-message");
      messageInput.value = "";

      const thinkingIndicator = appendMessage(
        "AI",
        "Thinking...",
        "agent-message",
        true
      );

      try {
        const response = await fetch("/api/ask_agent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: userQuery }),
        });

        thinkingIndicator.remove();

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Something went wrong");
        }

        const data = await response.json();
        appendMessage("AI", data.response, "agent-message");
      } catch (error) {
        thinkingIndicator.remove();
        appendMessage(
          "AI",
          `Sorry, an error occurred: ${error.message}`,
          "agent-message"
        );
        console.error("Error asking agent:", error);
      }
    });

    function appendMessage(sender, text, type, isThinking = false) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", type);

      const avatarDiv = document.createElement("div");
      avatarDiv.classList.add("message-avatar");
      avatarDiv.textContent = sender;

      const contentDiv = document.createElement("div");
      contentDiv.classList.add("message-content");

      if (isThinking) {
        contentDiv.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Thinking...';
      } else {
        // Render Markdown for agent messages
        if (type === "agent-message") {
          contentDiv.innerHTML = marked.parse(text);
        } else {
          contentDiv.textContent = text;
        }
      }

      if (type === "user-message") {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
      } else {
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageDiv;
    }
  });
</script>
{% endblock %}
