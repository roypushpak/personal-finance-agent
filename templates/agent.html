{% extends "base.html" %} {% block title %}AI Budgeting Agent{% endblock %} {%
block content %}
<style>
  #chat-container {
    max-width: 800px;
    margin: 2rem auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    height: 70vh;
    display: flex;
    flex-direction: column;
  }
  #chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0.5rem;
    margin-bottom: 1rem;
  }
  .message {
    margin-bottom: 1rem;
    padding: 0.75rem 1.25rem;
    border-radius: 0.375rem;
    max-width: 80%;
  }
  .user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
  }
  .agent-message {
    background-color: #e9ecef;
    color: #212529;
    margin-right: auto;
  }
  .agent-message.thinking {
    font-style: italic;
    color: #6c757d;
  }
</style>

<div id="chat-container">
  <div id="chat-messages">
    <div class="agent-message">
      Hello! I'm your AI budgeting assistant. Ask me anything about your recent
      transactions.
    </div>
  </div>
  <form id="chat-form" class="d-flex">
    <input
      type="text"
      id="message-input"
      class="form-control me-2"
      placeholder="e.g., How much did I spend on shopping?"
      required
    />
    <button type="submit" class="btn btn-primary">Send</button>
  </form>
</div>
{% endblock %} {% block body_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const chatMessages = document.getElementById("chat-messages");

    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const userMessage = messageInput.value.trim();
      if (!userMessage) return;

      // Display user's message
      appendMessage(userMessage, "user");
      messageInput.value = "";

      // Show a thinking indicator
      const thinkingIndicator = appendMessage("Thinking...", "agent", true);

      // Send to backend and get response
      try {
        const response = await fetch("/api/ask_agent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: userMessage }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Remove thinking indicator and show final answer
        thinkingIndicator.remove();
        appendMessage(data.answer, "agent");
      } catch (error) {
        thinkingIndicator.remove();
        appendMessage(
          "Sorry, something went wrong. Please try again.",
          "agent"
        );
        console.error("Error asking agent:", error);
      }
    });

    function appendMessage(text, type, isThinking = false) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", `${type}-message`);
      if (isThinking) {
        messageDiv.classList.add("thinking");
      }
      messageDiv.textContent = text;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
      return messageDiv;
    }
  });
</script>
{% endblock %}
