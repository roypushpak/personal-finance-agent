{% extends "base.html" %} {% block title %}Financial Overview{% endblock %} {%
block content %}
<div
  class="container-fluid"
  id="chart-data"
  data-chart="{{ chart_data | tojson | safe }}"
>
  <h1 class="h2">Dashboard</h1>
  <p class="text-muted">
    A summary of your financial activity over the last 30 days.
  </p>

  {% if error %}
  <div class="alert alert-danger">
    <strong>Error:</strong> {{ error.error_code }} - {{ error.message }}
    <p>
      Could not retrieve transaction data. Please try linking your account
      again.
    </p>
  </div>
  {% elif not total_outgoing and not total_income %}
  <div class="alert alert-info">
    <p>No transactions found for the last 30 days.</p>
  </div>
  {% else %}
  <!-- Stat Cards -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card text-white bg-success mb-3">
        <div class="card-body">
          <h5 class="card-title">Total Income</h5>
          <p class="card-text fs-4">${{ "%.2f"|format(total_income|abs) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-white bg-danger mb-3">
        <div class="card-body">
          <h5 class="card-title">Total Expenses</h5>
          <p class="card-text fs-4">${{ "%.2f"|format(total_outgoing) }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Recent Transactions -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Spending by Category</div>
        <div class="card-body">
          <canvas id="expensePieChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Recent Transactions</div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Merchant</th>
                <th>Category</th>
                <th class="text-end">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transactions %}
              <tr>
                <td>{{ t.date }}</td>
                <td>{{ t.name }}</td>
                <td>
                  <span class="badge bg-secondary">{{ t.category }}</span>
                </td>
                <td class="text-end">${{ "%.2f"|format(t.amount) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center">No recent transactions.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chartDataEl = document.getElementById("chart-data");
    if (chartDataEl) {
      const chartData = JSON.parse(chartDataEl.dataset.chart);
      if (chartData && chartData.labels.length > 0) {
        new Chart(document.getElementById("expensePieChart"), {
          type: "pie",
          data: {
            labels: chartData.labels,
            datasets: [
              {
                label: "Spending",
                data: chartData.data,
                backgroundColor: [
                  "#0d6efd",
                  "#6c757d",
                  "#198754",
                  "#dc3545",
                  "#ffc107",
                  "#0dcaf0",
                  "#d63384",
                  "#fd7e14",
                  "#6f42c1",
                  "#20c997",
                ],
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }
    }
  });
</script>
{% endblock %}
