{% extends "base.html" %} {% block title %}Budget Overview{% endblock %} {%
block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} {% block content %}
<h1 class="mt-5">Your Budget Overview</h1>
<p class="lead">A 30-day summary of your incoming and outgoing transactions.</p>

{% if overall_summary %}
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Overall Spending Progress</h5>
    <div class="d-flex justify-content-between">
      <span>${{ "%.2f"|format(overall_summary.spent) }}</span>
      <span class="text-muted"
        >${{ "%.2f"|format(overall_summary.limit) }}</span
      >
    </div>
    <div class="progress" style="height: 25px">
      {% set progress_color = 'bg-success' if overall_summary.percentage <= 75
      else 'bg-warning' if overall_summary.percentage <= 100 else 'bg-danger' %}
      <div
        class="progress-bar {{ progress_color }}"
        role="progressbar"
        style="width: {{ overall_summary.percentage }}%;"
        aria-valuenow="{{ overall_summary.percentage }}"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        <strong>{{ "%.0f"|format(overall_summary.percentage) }}%</strong>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row mt-4">
  <div class="col-md-6">
    <h2 class="text-center">Outgoing by Category</h2>
    <canvas id="expenseChart"></canvas>
  </div>
  <div class="col-md-6">
    <h2 class="text-center">Incoming by Category</h2>
    <canvas id="incomeChart"></canvas>
  </div>
</div>

{% if product_not_ready %}
<div class="alert alert-info mt-4" role="alert">
  <p>
    Your transaction data is being prepared. This page will refresh
    automatically in a few seconds.
  </p>
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<script>
  setTimeout(() => {
    window.location.reload();
  }, 7000);
</script>
{% endif %} {% if error %}
<div class="alert alert-danger mt-4" role="alert">
  <p>Oh no! Something went wrong:</p>
  <pre>{{ error | tojson }}</pre>
  <a href="/" class="btn btn-primary mt-2">Try Again</a>
</div>
{% endif %} {% endblock %} {% block body_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Expense Chart
    const expenseLabels = {{ expense_chart_data.labels | tojson }};
    const expenseValues = {{ expense_chart_data.data | tojson }};
    if (expenseLabels.length > 0) {
      new Chart(document.getElementById('expenseChart'), {
        type: 'pie',
        data: {
          labels: expenseLabels,
          datasets: [{
            data: expenseValues,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'top',
              display: true
            }
          }
        }
      });
    }

    // Income Chart
    const incomeLabels = {{ income_chart_data.labels | tojson }};
    const incomeValues = {{ income_chart_data.data | tojson }};
    if (incomeLabels.length > 0) {
      const categoryColors = {
        'Income': '#28a745',   // Bootstrap success green
        'Interest': '#007bff', // Bootstrap primary blue
        'Refund': '#6c757d'    // Bootstrap secondary gray
      };
      const backgroundColors = incomeLabels.map(label => categoryColors[label] || '#FFCE56'); // Default to yellow if unknown

      new Chart(document.getElementById('incomeChart'), {
        type: 'pie',
        data: {
          labels: incomeLabels,
          datasets: [{
            data: incomeValues,
            backgroundColor: backgroundColors
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'top',
              display: true
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}
